{"version":3,"sources":["../src/datasource.js"],"names":["Datasource","instanceSettings","$q","backendSrv","templateSrv","doQuery","query","format","datasourceRequest","url","method","data","headers","Authorization","token","then","result","doQueries","Promise","all","queries","map","getVariables","toValue","text","x","value","replaceInterval","slice","range","from","options","utc","to","vars","__from","__to","__range","scopedVars","__interval","Object","keys","key","reduce","y","transformDate","d","Date","parse","maxDurationYear","epochYear","transformValue","v","window","atob","error","transformResponse","response","tables","length","table","timestamps","columns","colCount","rowCount","c","i","name","type","rows","row","j","push","results","target","datapoints","idx","transformAll","a","b","securityEnabled","jsonData","username","usersecret","secret","id","token_expiry","now","status","message","console","login","Error","variables","targets","filter","t","hide","rawSql","resultFormat","replace","checkToken","transformedResults"],"mappings":"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","file":"datasource.js","sourcesContent":["export default class Datasource {\n  constructor(instanceSettings, $q, backendSrv, templateSrv) {\n    const securityEnabled = instanceSettings.jsonData.securityEnabled\n    const username = securityEnabled ? instanceSettings.jsonData.name : 'anonymous'\n    const usersecret = securityEnabled ? instanceSettings.jsonData.secret : ''\n    const maxDurationYear = Date.parse('1971-01-01')\n    const epochYear  = Date.parse('1970-01-01')\n\n    this.name = instanceSettings.name\n    this.id = instanceSettings.id\n    this.url = instanceSettings.url\n    this.username = username\n    this.usersecret = usersecret\n    this.token = ''\n    this.token_expiry = Date.now()\n\n    this.$q = $q\n    this.backendSrv = backendSrv\n    this.templateSrv = templateSrv\n    \n    this.maxDurationYear = maxDurationYear\n    this.epochYear = epochYear\n  }\n\n  async login() {\n    try {\n      const result = await this.backendSrv.datasourceRequest({\n        url: `${this.url}/api/login`,\n        method: 'POST',\n        data: `{ \"username\": \"${this.username}\", \"secret_key\": \"${this.usersecret}\" }`,\n        headers: {\n          'Content-Type': 'application/json'\n        }\n      })\n\n      this.token = result.data.token\n      this.token_expiry = Date.now() + 10 * 60 * 60 * 1000\n\n      const status = 'success'\n      const message = 'QuasarDB connection is OK!'\n      return { status, message }\n    } catch (err) {\n      const status = 'error'\n      const message = 'Unable to connect to datasource. See console for detailed information.'\n\n      if (process.env.NODE_ENV !== 'dev') {\n        console.error('QDB CONNECTION ERROR:', err)\n      }\n\n      return { status, message }\n    }\n  }\n\n  async checkToken() {\n    if (this.token === '' || this.token_expiry - Date.now() < 1000) {\n      const result = await this.login()\n\n      if (result.status === 'error') {\n        throw new Error(result.message)\n      }\n    }\n\n    return\n  }\n\n  doQuery = ({ query, format }) => {\n    return this.backendSrv.datasourceRequest({\n      url: `${this.url}/api/query`,\n      method: 'POST',\n      data: `{ \"query\" : \"${query}\" }`,\n      headers: {\n        'Content-Type': 'application/json',\n        Authorization: `Bearer ${this.token}`\n      }\n    }).then(result => {\n      result.data.format = format\n      return result\n    })\n  }\n\n  doQueries = queries => Promise.all(queries.map(this.doQuery))\n\n  getVariables = options => {\n    const toValue = x => ({\n      text: x,\n      value: x\n    })\n\n    const replaceInterval = x => (x.slice(-1) === 'm' ? `${x}in` : x)\n\n    const range = {\n      from: options.range.from.utc().format('YYYY-MM-DD[T]HH:mm:ss'),\n      to: options.range.to.utc().format('YYYY-MM-DD[T]HH:mm:ss')\n    }\n\n    const vars = {\n      __from: range.from,\n      __to: range.to,\n      __range: `range(${range.from}, ${range.to})`\n    }\n\n    if (options.scopedVars && options.scopedVars.__interval) {\n      const { value } = options.scopedVars.__interval\n      vars.__interval = replaceInterval(value)\n    }\n\n    return {\n      ...options.scopedVars,\n      ...Object.keys(vars)\n        .map(key => ({ [key]: toValue(vars[key]) }))\n        .reduce((x, y) => ({ ...y, ...x }), {})\n    }\n  }\n\n  transformDate = value => {\n    let d = Date.parse(value)\n    // handle timestamp as duration\n    if (d < this.maxDurationYear) {\n      return d - this.epochYear\n    }\n    return d\n  }\n\n  transformValue = value => {\n    if (typeof value == 'string') {\n      try {\n        let v = window.atob(value)\n        return v\n      } catch (error) {\n        return value\n      }\n    }\n    return value\n  }\n\n  transformResponse = response => {\n    const result = response.data\n    if (result.tables.length === 0) {\n      return []\n    }\n\n    switch (response.data.format) {\n      case 'table': {\n        const table = result.tables[0]\n        const timestamps = table.columns[0].data\n        const colCount = table.columns.length\n        const rowCount = table.columns[0].data.length\n        const columns = table.columns.map((c, i) => {\n          let result = { text: c.name }\n          if (i === 0) {\n            result.type = 'time'\n          }\n          return result\n        })\n        let rows = []\n        for (let i = 0; i < rowCount; i++) {\n          let row = []\n          for (let j = 0; j < colCount; j++) {\n            const value = table.columns[j].data[i]\n\n            if (j == 0) {\n              row.push(this.transformDate(value))\n            } else {\n              row.push(transformValue(value))\n            }\n          }\n          rows.push(row)\n        }\n\n        return [{\n          columns,\n          rows,\n          type: 'table'\n        }]\n      }\n      default: {\n        const table = result.tables[0]\n        const timestamps = table.columns[0].data\n\n        let results = []\n\n        for (let i = 1; i < table.columns.length; i++) {\n          const target = table.columns[i].name\n          const datapoints = table.columns[i].data.map((value, idx) => [\n            value,\n            row.push(this.transformDate(value))\n          ])\n          results.push({ target, datapoints })\n        }\n\n        return results\n      }\n    }\n  }\n\n  transformAll = results => {\n    const data = results.map(this.transformResponse).reduce((a, b) => [...a, ...b], [])\n    return { data }\n  }\n\n  async query(options) {\n    const variables = this.getVariables(options)\n\n    const queries = options.targets\n      .filter(t => !t.hide && t.rawSql)\n      .map(t => {\n        return {\n          format: t.resultFormat,\n          query: this.templateSrv.replace(t.rawSql, variables)\n        }\n      })\n\n    if (!queries.length) {\n      return { data: [] }\n    }\n\n    await this.checkToken()\n    const results = await this.doQueries(queries)\n    const transformedResults = await this.transformAll(results)\n    return transformedResults\n  }\n\n  annotationQuery(options) {\n    throw new Error('annotations not yet implemented.')\n  }\n\n  metricFindQuery(query) {\n    throw new Error('metrics not yet implemented.')\n  }\n\n  testDatasource() {\n    return this.login()\n  }\n}\n"]}